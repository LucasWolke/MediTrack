<div class="flex justify-content-end p-2">

  <p-button
    class="m-2"
    [outlined]="true"
    *ngIf="checkEditingAuthority()  && editing"
    type="button"
    (click)="createNewSchedule()"
    severity="success"
    icon="pi pi-check-circle"
    label="{{'Publish'}}"/>


  <p-button
    class="m-2"
    [outlined]="true"
    *ngIf="displayCreateScheduleButton"
    type="button"
    (click)="createNewSchedule()"
    label="{{'Create plan for ' + missingMonth}}"/>

  <p-confirmDialog/>

  <p-button
    class="m-2"
    [outlined]="true"
    *ngIf="checkEditingAuthority() && !displayCreateScheduleButton && editing"
    type="button"
    (click)="confirmDelete($event)"
    icon="pi pi-times"
    severity="danger"
    label="{{'Delete'}}"/>

  <p-button
    class="m-2"
    [outlined]="true"
    *ngIf="checkEditingAuthority() && !editing && !displayCreateScheduleButton"
    type="button"
    (click)="toggleEdit()"
    icon="pi pi-pencil"
    label="{{'Edit'}}"/>

  <p-button
    class="m-2"
    [outlined]="true"
    *ngIf="checkEditingAuthority() && editing"
    type="button"
    (click)="toggleEdit()"
    icon="pi pi-check"
    label="{{'Done'}}"/>

</div>
<p-table #dt [value]="users" [customSort]="true" class="p-mt-2" [scrollable]="true" scrollHeight='70vh'
         styleClass="p-datatable-gridlines" responsiveLayout="scroll"
         [style]="editing ? {'border': '1px solid  var(--primary-color)'} : {}"
         [globalFilterFields]="['firstName','lastName', 'role.name']" [loading]=" loading">
  <ng-template pTemplate="caption">
    <div class="flex flex-column md:flex-row md:justify-content-between md:align-items-center">
      <h5 *ngIf="range==='week'" class="m-0">Calendar Week {{ weekNumber }}</h5>
      <h5 *ngIf="weekNumber && range==='2weeks'" class="m-0">Calendar Week {{ weekNumber }}/{{ weekNumber + 1 }}</h5>
      <h5 *ngIf="range==='month'" class="m-0">Calendar Month {{ monthNumber }}</h5>
      <div class="flex align-items-center justify-content-start">
        <p-button *ngIf="!editing"
                  type="button"
                  icon="pi pi-chevron-left"
                  (click)="previousWeek()"
                  styleClass="p-button-text"/>

        <h5 class="inline m-0 p-2">{{ days[0].dayName }} -  {{ days[days.length - 1].dayName }}</h5>

        <p-button *ngIf="!editing"
                  type="button"
                  icon="pi pi-chevron-right"
                  (click)="nextWeek()"
                  styleClass="p-button-text"/>
      </div>
      <div class="flex justify-content-center align-items-center">

        <p-columnFilter field="role.name" [showMenu]="false">
          <ng-template pTemplate="filter" let-value let-filter="filterCallback">
            <p-dropdown [ngModel]="value" optionValue="name" optionLabel="name" [options]="roles"
                        (onChange)="filter($event.value)" placeholder="Role">
            </p-dropdown>
          </ng-template>
        </p-columnFilter>

      </div>

      <div *ngIf="!editing">
        <p-dropdown
          [ngModel]="range"
          [options]="rangeOptions"
          (onChange)="setRange($event.value)"
          placeholder="Select Range">
        </p-dropdown>
      </div>

      <span class="block mt-2 md:mt-0 p-input-icon-left">
                    <i class="pi pi-search"></i>
                    <input pInputText (input)="onGlobalFilter(dt, $event)" type="text" placeholder="Search..."
                           class="w-full sm:w-auto"/>
                </span>
    </div>
  </ng-template>
  <ng-template pTemplate="header">
    <tr class="font-semibold">
      <th pFrozenColumn>Employees</th>
      <!-- TODO: Weekend check should be language independent -->
      <th [ngStyle]="{
      'background-color': day.dayName.includes('Su') || day.dayName.includes('Sa') ? 'lightgray' : '#fff'}"
          *ngFor="let day of days">{{ (day.dayName) }}
      </th>
    </tr>
  </ng-template>
  <ng-template pTemplate="body" let-user>
    <tr>
      <td pFrozenColumn>
        <div pSortableColumn="username">{{ user.firstName }} {{ user.lastName }}</div>
        <div class="text-sm flex align-items-center justify-content-start"><span
          class="pi pi-clock mr-1"></span>{{ user.workingHoursPercentage }}%
        </div>
        <div class="text-sm">{{ user.role.name }}</div>
      </td>
      <!-- TODO: Weekend check should be language independent -->
      <td *ngFor="let day of days; index as i"
          [ngStyle]="getDayStyle(user, day)"
          [ngClass]="{'cursor-pointer': editing}"
          (click)="editing && op.toggle($event); editing && this.setShiftType(getShiftTypeFromDate(user.id, day.date))">

        <ng-container *ngIf="getShiftTypeFromDate(user.id, day.date) as shiftType;">
          <div>
            <div class="text-xl font-medium">
              {{ shiftType.abbreviation }}
            </div>
            <span *ngIf="range!=='month'" class="text-sm">
             {{ shiftType.startTime.slice(0, -3) }} - {{ shiftType.endTime.slice(0, -3) }}
            </span>
          </div>
        </ng-container>
        <p-overlayPanel #op>
          <p-dropdown
            [(ngModel)]="this.currentShiftType"
            [options]="shiftTypes"
            optionLabel="name"
            [showClear]="true"
            placeholder="Select a Shift Type"
          >
          </p-dropdown>
          <div class="flex justify-content-end flex-wrap">
            <div *ngIf="getShiftTypeFromDate(user.id, day.date) as shiftType; else newShift;">
              <p-button
                class="m-2"
                [outlined]="true"
                type="button"
                (click)="changeShift(user, day, getShiftIdFromDate(user.id, day.date), 'delete')"
                label="Delete shift"
                severity="danger">
              </p-button>
              <p-button
                class="m-2"
                [outlined]="true"
                type="button"
                (click)="changeShift(user, day, getShiftIdFromDate(user.id, day.date), 'update')"
                label="Update shift">
              </p-button>
            </div>
            <ng-template #newShift>
              <p-button
                class="m-2"
                [outlined]="true"
                type="button"
                (click)="changeShift(user, day, null, 'create')"
                label="Create shift">
              </p-button>
            </ng-template>
          </div>
        </p-overlayPanel>
      </td>
    </tr>
  </ng-template>
</p-table>
